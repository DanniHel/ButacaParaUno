<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Catálogo — Dulcería</title>
<style>
* { box-sizing: border-box; }
html, body { margin:0; padding:0; background:#0E0F12; color:#ECEFF7; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
a { color: inherit; text-decoration: none; }
button, .btn { background:#1F232B; border:1px solid #2A2E37; color:#ECEFF7; border-radius:8px; padding:10px 14px; cursor:pointer; }
.btn.primary { background:#F2B705; color:#111; border-color:#F2B705; }
.container { max-width:1040px; margin:0 auto; padding:24px; }
.h { font-weight:800; margin:8px 0; font-size:20px; }
.hr { height:1px; background:#2A2E37; border:0; margin:12px 0; }
.row { display:flex; gap:8px; align-items:center; }
.row-spc { display:flex; justify-content:space-between; align-items:center; gap:12px; }
.input { background:#161A22; border:1px solid #2A2E37; border-radius:8px; padding:10px; color:#ECEFF7; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:14px; margin-top:12px; }
.card { border:1px solid #2A2E37; border-radius:12px; overflow:hidden; background:#151820; display:flex; flex-direction:column; }
.card img { display:block; width:100%; height:120px; object-fit:cover; }
.card .body { padding:12px; flex:1; display:flex; flex-direction:column; justify-content:space-between; }
.price { font-weight:700; color:#A7AEBE; margin-top:4px; font-size: 14px; }
.actions { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:10px; }
.meta { color:#A7AEBE; }
.notice { padding:10px 12px; border:1px solid #2A2E37; border-radius:8px; background:#151923; color:#DDE3F1; margin-top:8px; }
.notice.ok { border-color:#27562E; background:#17231A; color:#C2E5C7; }
.notice.error { border-color:#7D2D2D; background:#2A1B1B; color:#F2C9C9; }
.footer { margin-top:24px; border-top:1px solid #2A2E37; padding-top:12px; display:flex; justify-content:space-between; align-items:center; }
.totalbox { text-align:right; }
.totalbox div { margin:4px 0; }

/* --- ESTILOS PARA EL MODAL --- */
.modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:1000; }
.modal-content { background:#13161B; padding:24px; border-radius:12px; border:1px solid #2A2E37; width:90%; max-width:480px; }
.modal-options .option-group { margin-bottom:16px; }
.modal-options label { display:block; margin-bottom:8px; font-weight:700; color:#A7AEBE; }
.modal-options .choices { display:flex; gap:8px; flex-wrap:wrap; }
.modal-options input[type=radio] { display:none; }
.modal-options input[type=radio] + span { padding:8px 12px; border:1px solid #2A2E37; border-radius:8px; cursor:pointer; background:#1F232B; }
.modal-options input[type=radio]:checked + span { background:#F2B705; color:#111; border-color:#F2B705; font-weight:700; }
.modal-footer { display:flex; justify-content:space-between; align-items:center; margin-top:24px; border-top:1px solid #2A2E37; padding-top:16px; }
.modal-price { font-size:20px; font-weight:800; color:#F2B705; }
</style>
</head>
<body>
<div class="container">
  <div class="row-spc">
    <div class="h">Butaca Para Uno — Catálogo de Dulcería</div>
    <div class="row">
      <a class="btn" href="inicio_dulceria.html">Inicio</a>
      <a class="btn" href="cancelar.html">Cancelar Venta</a>
    </div>
  </div>
  <div class="hr"></div>
  <div class="row" style="margin-bottom:8px;">
    <input id="search" class="input" style="flex:1;" placeholder="Buscar producto...">
    <button class="btn" id="btn-search">Buscar</button>
  </div>
  <div id="catalogo" class="grid"></div>
  <div id="msg" class="notice">Seleccione los productos para el pedido.</div>
  <div class="footer">
    <button class="btn" id="btn-clear">Limpiar Pedido</button>
    <div class="totalbox">
      <div>Subtotal: <span id="subtotal">S/ 0.00</span></div>
      <div>IGV (18%): <span id="igv">S/ 0.00</span></div>
      <div style="font-weight:800;">Total: <span id="total">S/ 0.00</span></div>
      <div style="margin-top:8px;">
        <a class="btn primary" href="pedido.html">Continuar</a>
      </div>
    </div>
  </div>
</div>

<!-- --- MODAL DE PERSONALIZACIÓN --- -->
<div class="modal-overlay" id="customization-modal">
  <div class="modal-content">
    <div id="modal-title" class="h">Personalizar Producto</div>
    <div class="hr"></div>
    <div id="modal-options" class="modal-options"></div>
    <div id="modal-msg" class="notice" style="display:none; margin-top:16px;"></div>
    <div class="modal-footer">
      <div id="modal-price" class="modal-price">S/ 0.00</div>
      <div class="row">
        <button class="btn" id="btn-modal-cancel">Cancelar</button>
        <button class="btn primary" id="btn-modal-add">Añadir al Pedido</button>
      </div>
    </div>
  </div>
</div>

<script>
/* === DATOS CON STOCK === */
const allProducts = [
  { id:101, name:"Palomitas Mantequilla (Mediana)", price:15, stock: 10 },
  { id:102, name:"Palomitas Mantequilla (Grande)", price:18, stock: 8 },
  { id:103, name:"Palomitas Dulces (Mediana)", price:17, stock: 5 },
  { id:104, name:"Palomitas Dulces (Grande)", price:20, stock: 0 }, // AGOTADO PARA PRUEBAS
  { id:201, name:"Gaseosa (Mediana)", price:10, stock: 20 },
  { id:202, name:"Gaseosa (Grande)", price:12, stock: 15 },
  { id:203, name:"Agua Mineral", price:8, stock: 30 },
  { id:301, name:"Combo 1", price:25, stock: 10 },
  { id:302, name:"Combo 2", price:45, stock: 5 },
  { id:401, name:"Chocolate", price:9, stock: 3 }, // STOCK BAJO PARA PRUEBAS
];

const baseProducts = [
  { 
    baseId: "palomitas", 
    name: "Palomitas",
    img: "https://cdn.milenio.com/uploads/media/2021/01/19/las-palomitas-se-volvieron-populares_0_61_960_598.jpg",
    priceRange: "Desde S/ 15.00",
    options: {
      "Forma": [{ name: "Mantequilla", value: "mantequilla" }, { name: "Dulces", value: "dulces" }],
      "Presentación": [{ name: "Mediana", value: "mediana" }, { name: "Grande", value: "grande" }]
    },
    variants: {
      "mantequilla-mediana": 101, "mantequilla-grande": 102,
      "dulces-mediana": 103, "dulces-grande": 104,
    }
  },
  { 
    baseId: "bebidas",
    name: "Bebidas",
    img: "https://mir-s3-cdn-cf.behance.net/projects/202/892e8483979207.Y3JvcCw3MzUsNTc1LDIyMiw0OQ.jpg",
    priceRange: "Desde S/ 8.00",
    options: {
      "Forma": [{ name: "Gaseosa", value: "gaseosa" }, { name: "Agua Mineral", value: "agua" }],
      "Presentación": [{ name: "Mediana", value: "mediana" }, { name: "Grande", value: "grande" }]
    },
    variants: {
      "gaseosa-mediana": 201, "gaseosa-grande": 202,
      "agua-mediana": 203, "agua-grande": 203,
    }
  },
  { baseId: 301, name: "Combo 1", img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTjaKAMN8VIeIhu7F5b-lf3RaeLht-Om9-6dw&s", priceRange: "S/ 25.00", isDirect: true },
  { baseId: 302, name: "Combo 2", img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTOelx_FZxVj-T5p2nBMaBTvgKpjRz4L6S7DQ&s", priceRange: "S/ 45.00", isDirect: true },
  { baseId: 401, name: "Chocolate", img: "https://aicdn.speedsize.com/910565e2-7bde-4aef-b143-60a77dc084e5/https://regalooriginalfiles.blob.core.windows.net/frontend/urls/grande/tableta-chocolate-amor-de-cine-g2.jpg", priceRange: "S/ 9.00", isDirect: true },
];

let pedido = JSON.parse(localStorage.getItem("pedido_dulceria") || "{}");
let currentCustomization = {};

/* === RENDERIZADO DEL CATÁLOGO CON LÓGICA CONDICIONAL === */
function renderCatalogo(list = baseProducts){
  const cont = document.getElementById("catalogo");
  cont.innerHTML = "";
  list.forEach(p => {
    const card = document.createElement("div");
    card.className = "card";
    
    let actionsHTML = '';
    // Si es un producto directo (sin personalización), muestra los botones +/-
    if (p.isDirect) {
      const currentQty = pedido[p.baseId] || 0;
      actionsHTML = `
        <div class="actions">
          <button class="btn" data-action="minus" data-id="${p.baseId}">-</button>
          <div id="qty-${p.baseId}" class="meta">${currentQty}</div>
          <button class="btn primary" data-action="plus" data-id="${p.baseId}">+</button>
        </div>`;
    } else {
      // Si necesita personalización, muestra un solo botón
      actionsHTML = `
        <div class="actions">
          <button class="btn primary" data-customize="${p.baseId}" style="width:100%;">Elegir Opciones</button>
        </div>`;
    }

    card.innerHTML = `
      <img src="${p.img}" alt="${p.name}">
      <div class="body">
        <div>
          <div style="font-weight:700;">${p.name}</div>
          <div class="price">${p.priceRange}</div>
        </div>
        ${actionsHTML}
      </div>`;
    cont.appendChild(card);
  });
}

/* === LÓGICA DEL MODAL (SIN CAMBIOS SIGNIFICATIVOS) === */
const modal = document.getElementById("customization-modal");
const modalMsg = document.getElementById("modal-msg");

function openModal(baseId) {
  currentCustomization = { baseId, selections: {} };
  const product = baseProducts.find(p => p.baseId === baseId);
  if (!product || !product.options) return;

  document.getElementById("modal-title").textContent = `Personalizar ${product.name}`;
  const optionsContainer = document.getElementById("modal-options");
  optionsContainer.innerHTML = "";

  Object.entries(product.options).forEach(([groupName, choices]) => {
    const groupEl = document.createElement("div");
    groupEl.className = "option-group";
    let choicesHTML = choices.map((choice, index) => `
      <label>
        <input type="radio" name="${groupName}" value="${choice.value}" ${index === 0 ? 'checked' : ''}>
        <span>${choice.name}</span>
      </label>`).join('');
    groupEl.innerHTML = `<label>${groupName}</label><div class="choices">${choicesHTML}</div>`;
    optionsContainer.appendChild(groupEl);
  });
  
  optionsContainer.querySelectorAll('input[type=radio]').forEach(radio => {
    radio.addEventListener('change', updateModalPrice);
  });

  updateModalPrice();
  modalMsg.style.display = "none";
  modal.style.display = "flex";
}

function updateModalPrice() {
  const product = baseProducts.find(p => p.baseId === currentCustomization.baseId);
  const selectionKey = Array.from(document.querySelectorAll('#modal-options input:checked')).map(i => i.value).join('-');
  const finalProductId = product.variants[selectionKey];
  const finalProduct = allProducts.find(p => p.id === finalProductId);

  if (finalProduct) {
    document.getElementById("modal-price").textContent = `S/ ${finalProduct.price.toFixed(2)}`;
    currentCustomization.finalProductId = finalProductId;
  } else {
    document.getElementById("modal-price").textContent = "No disp.";
    currentCustomization.finalProductId = null;
  }
}

function closeModal() {
  modal.style.display = "none";
}

/* === LÓGICA DE EVENTOS (CLICK) UNIFICADA === */
document.addEventListener("click", e => {
  const mainMsg = document.getElementById("msg");

  // --- Caso 1: Botones +/- para productos directos ---
  if (e.target.matches("[data-action]")) {
    const id = e.target.dataset.id;
    const action = e.target.dataset.action;
    const prod = allProducts.find(p => p.id == id);
    if (!prod) return;

    let currentQty = pedido[id] || 0;

    if (action === "plus") {
      if (currentQty < prod.stock) {
        currentQty++;
        mainMsg.className = "notice ok";
        mainMsg.textContent = `"${prod.name}" añadido al pedido.`;
      } else {
        // ALERTA DE STOCK (FA-001)
        mainMsg.className = "notice error";
        mainMsg.textContent = `Producto Agotado: No hay más stock para "${prod.name}".`;
        return;
      }
    } else if (action === "minus") {
      if (currentQty > 0) currentQty--;
    }
    
    if (currentQty > 0) pedido[id] = currentQty;
    else delete pedido[id];
    
    document.getElementById(`qty-${id}`).textContent = currentQty;
    recalc();
  }

  // --- Caso 2: Botón "Elegir Opciones" para productos personalizables ---
  if (e.target.matches("[data-customize]")) {
    openModal(e.target.dataset.customize);
  }
});


/* === EVENTOS DEL MODAL (CON VALIDACIÓN DE STOCK) === */
document.getElementById("btn-modal-add").addEventListener('click', () => {
  const finalId = currentCustomization.finalProductId;
  if (finalId) {
    const prod = allProducts.find(p => p.id === finalId);
    let currentQty = pedido[finalId] || 0;

    // VALIDACIÓN DE STOCK ANTES DE AÑADIR DESDE EL MODAL
    if (currentQty < prod.stock) {
      pedido[finalId] = currentQty + 1;
      document.getElementById("msg").className = "notice ok";
      document.getElementById("msg").textContent = `"${prod.name}" añadido al pedido.`;
      recalc();
      closeModal();
    } else {
      modalMsg.className = "notice error";
      modalMsg.textContent = "Producto Agotado. No se puede añadir.";
      modalMsg.style.display = "block";
    }
  }
});

document.getElementById("btn-modal-cancel").addEventListener('click', closeModal);
modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });


/* === FUNCIONES DE APOYO (RECALCULAR TOTALES, BÚSQUEDA, ETC.) === */
function recalc() {
  let subtotal = 0;
  for (const [id, cant] of Object.entries(pedido)) {
    const prod = allProducts.find(p => p.id == id);
    if (prod) subtotal += prod.price * cant;
  }
  const igv = +(subtotal * 0.18).toFixed(2);
  const total = +(subtotal + igv).toFixed(2);
  document.getElementById("subtotal").textContent = "S/ " + subtotal.toFixed(2);
  document.getElementById("igv").textContent = "S/ " + igv.toFixed(2);
  document.getElementById("total").textContent = "S/ " + total.toFixed(2);
  localStorage.setItem("pedido_dulceria", JSON.stringify(pedido));
}

document.getElementById("btn-clear").addEventListener("click", () => {
  pedido = {};
  renderCatalogo();
  recalc();
  document.getElementById("msg").textContent = "Pedido reiniciado.";
});

document.getElementById("btn-search").addEventListener("click", () => {
  const q = document.getElementById("search").value.trim().toLowerCase();
  const results = baseProducts.filter(p => p.name.toLowerCase().includes(q));
  renderCatalogo(results.length ? results : baseProducts);
  document.getElementById("msg").textContent = results.length ? `Resultados: ${results.length}` : "Sin coincidencias, mostrando todo.";
});

/* === INICIALIZACIÓN === */
renderCatalogo();
recalc();
</script>
</body>
</html>